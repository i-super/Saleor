{% extends "dashboard/base.html" %}
{% load prices_i18n %}
{% load i18n %}
{% load bootstrap %}

{% block title %}Order details{% endblock %}

{% block content %}
<div class="row">
    <h1 class="page-header">Order #{{ order.id }}</h1>

    <div class="col-lg-8">
        <div class="panel panel-default">
            <div class="panel-heading">
                <span class="panel-title">Order details</span>
            </div>
            <div class="panel-body">
                <p>Order date: {{ order.created }}</p>
                <p>Order status: {% include 'dashboard/includes/_status_label.html' with status=order.status status_display=order.get_status_display %}</p>
                <p>Payment status: {% include 'dashboard/includes/_status_label.html' with status=order.get_last_payment_status status_display=order.get_last_payment_status_display %}</p>
            </div>
        </div>

        <div class="panel panel-default">
            <div class="panel-heading">
                <span class="panel-title">Order contents</span>
            </div>
            <div class="panel-body">
                <table class="table">
                    {% for item in order.get_items %}
                        <tr>
                            <td>
                                <a href="{% url "dashboard:product-update" pk=item.pk %}">{{ item.product_name }}</a>
                                SKU: {{ item.product_sku }}
                            </td>
                            <td>
                                {{ item.quantity }} x {% gross item.get_price_per_item %}
                            </td>
                        </tr>
                    {% endfor %}
                    <tr>
                        <td colspan="2"><strong>{% trans "Order totals" %}</strong></td>
                    </tr>
                    <tr>
                        <td>{% trans "Delivery" %}</td>
                        <td>{% gross order.get_delivery_total %}</td>
                    </tr>
                    <tr>
                        <td>
                            {% trans "Total" %}
                        </td>
                        <td>
                            {% gross order.get_total %}
                        </td>
                    </tr>
                </table>
            </div>
        </div>

        <div class="panel panel-default" id="order-notes">
            <div class="panel-heading">
                <span class="panel-title">Order notes</span>
                <span class="pull-right"><a data-toggle="collapse" href="#add-order-note"><i class="glyphicon glyphicon-plus"></i> Add note</a></span>
            </div>
            <div class="panel-body">
                {% if notes %}
                    <ul class="list-unstyled">
                    {% for note in notes %}
                        <li>
                            <small>{{ note.user }} - {{ note.date }}</small>
                            <p>{{ note.content }}</p>
                        </li>
                    {% endfor %}
                    </ul>
                {% else %}
                    <span>-</span>
                {% endif %}
                <div id="add-order-note" class="collapse">
                    <form class="form-horizontal" role="form" method="post">
                        {% csrf_token %}
                        {{ notes_form|as_vertical_form }}
                      <div class="form-group">
                          <button type="submit" class="btn btn-default">Save</button>
                      </div>
                    </form>
                </div>
            </div>
        </div>

        <div class="panel panel-default">
            <div class="panel-heading">
                <span class="panel-title">{% trans "Payment history" %}</span>
            </div>
            <div class="panel-body">
                <ul class="list-unstyled">
                {% for payment in order.payments.all %}
                    <li>
                        <span>{{ payment.created }}</span>
                        {% include 'dashboard/includes/_status_label.html' with status=payment.status status_display=payment.get_status_display %}
                        <a href="{% url "dashboard:payment-details" pk=payment.pk %}">Details</a>
                    </li>
                {% endfor %}
                </ul>
            </div>
        </div>
    </div>

    <div class="col-lg-4">
        <div class="panel panel-default">
            <div class="panel-heading">
                <span class="panel-title">Order history</span>
            </div>
            <div class="panel-body">
                <ul class="list-unstyled">
                {% for status_change in order.status_history.all %}
                    <li>
                        <span>{{ status_change.date }}</span>
                        {% include 'dashboard/includes/_status_label.html' with status=status_change.status status_display=status_change.get_status_display %}
                    </li>
                {% endfor %}
                </ul>
            </div>
        </div>
        <div class="panel panel-default">
            <div class="panel-heading">
                <span class="panel-title">Customer details <i class="glyphicon glyphicon-user pull-right"></i></span>
            </div>
            <div class="panel-body">
                <div class="address">
                    <div>Account: {{ order.user|default:"Anonymous" }}</div>
                    <div>
                        <span class="glyphicon glyphicon-envelope"></span>
                        {{ order.get_user_email }}
                    </div>
                    <div>IP Address: {{ request.META.REMOTE_ADDR }}</div>
                </div>
            </div>
        </div>

        <div class="panel panel-default">
            {% with order.billing_address as address %}
            <div class="panel-heading">
                <span class="panel-title">Billing address</span>
                <span class="pull-right"><a href="{% url "dashboard:address-edit" order_pk=order.pk address_type='billing' %}"><i class="glyphicon glyphicon-cog"></i> Edit</a></span>
            </div>
            <div class="panel-body">
                {% include 'dashboard/includes/_address.html' with address=address only %}
            </div>
            {% endwith %}
        </div>

        <div class="panel panel-default">
            {% with view.get_delivery_info as delivery %}
                <div class="panel-heading">
                    <span class="panel-title">Shipping address</span>
                    <span class="pull-right"><a href="{% url "dashboard:address-edit" order_pk=order.pk address_type='shipping' %}"><i class="glyphicon glyphicon-cog"></i> Edit</a></span>
                </div>
                <div class="panel-body">
                    {% if delivery %}
                        {% include 'dashboard/includes/_address.html' with address=delivery.address only %}
                    {% else %}
                        <span>No shipping address</span>
                    {% endif %}
                </div>
            {% endwith %}
        </div>

    </div>
</div>
{% endblock %}
